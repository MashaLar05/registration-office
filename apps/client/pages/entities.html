<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ table_name }} Management</title>
  </head>
  <body>
    <h2>CRUD for {{ table_name }}</h2>
    <div>
      <p>
        Id:<br/>
        <input id="id" />
      </p>
      <p>
        Ім'я:<br/>
        <input id="name" />
      </p>
      <p>
        Прізвище:<br/>
        <input id="last_name" />
      </p>
      <p>
        Роль:<br/>
        <select id="role">
          <option value="admin">admin</option>
          <option value="user">user</option>
        </select>
      </p>
      <p>
        Дата народження:<br/>
        <input type="datetime-local" id="date_of_birth" />
      </p>
      <p>
        <button id="saveBtn">Зберегти</button>
        <button id="resetBtn">Скинути</button>
      </p>
    </div>
    <table>
      <thead><tr><th>Ім'я</th><th>Прізвище</th><th>Роль</th><th>Дата народження</th></tr></thead>
      <tbody>
      </tbody>
    </table>
    <script>
      async function getUsers() {
        const response = await fetch("/users/", {
          method: "GET",
          headers: { "Accept": "application/json" }
        });
        if (response.ok === true) {
          const users = await response.json();
          const rows = document.querySelector("tbody");
          users.forEach(user => rows.append(row(user)));
        }
      }

      async function getUser(id) {
        const response = await fetch(`/users/${id}`, {
          method: "GET",
          headers: { "Accept": "application/json" }
        });
        if (response.ok === true) {
          const user = await response.json();
          document.getElementById("id").value = user.id;
          document.getElementById("name").value = user.name;
          document.getElementById("last_name").value = user.last_name;
          document.getElementById("date_of_birth").value = user.date_of_birth;
        }
        else{
          const error = await response.json();
          console.log(error.message);
        }
      }

      async function createUser(name, last_name, role, date_of_birth) {
        const response = await fetch ("/users/", {
             method: "POST",
             headers: {"Accept": "application/json", "Content-Type": "application/json"},
             body: JSON.stringify({
               name: name,
               last_name: last_name,
               role: role,
               date_of_birth: date_of_birth
             })
           });
           if (response.ok === true) {
             const user = await response.json();
             document.querySelector("tbody").append(row(user));
           }else{
             const error = await response.json();
             console.log(error.message);
           }
      }

      async function editUser(id, name, last_name, role, date_of_birth){
        const response = await fetch(`/users/${id}`, {
          method: "PUT",
          headers: { "Accept": "application/json", "Content-Type": "application/json" },
          body: JSON.stringify({
            name: name,
            last_name: last_name,
            role: role,
            date_of_birth: date_of_birth
          })
        });
         if (response.ok === true) {
           const user = await response.json();
           document.querySelector(`tr[data-rowid='${user.id}']`).replaceWith(row(user));
         }
         else{
           const error = await response.json();
           console.log(error.message);
         }
      }

      async function deleteUser(id){
        const response = await fetch(`/users/${id}`,{
          method: "DELETE",
          headers: {"Accept": "application/json"}
        });
        if (response.ok === true){
          const user = await response.json();
          document.querySelector(`tr[data-rowid='${user.id}']`).remove();
        }
        else{
          const error = await response.json();
          console.log(error.message);
        }
      }

      function reset() {
        document.getElementById("id").value =
        document.getElementById("name").value =
        document.getElementById("date_of_birth").value =
        document.getElementById("last_name").value = "";
      }

      function row(user){
        const tr = document.createElement("tr");
        tr.setAttribute("data-rowid", user.id);
        const nameTd = document.createElement("td");
        nameTd.append(user.name);
        tr.append(nameTd);
        const last_nameTd = document.createElement("td");
        last_nameTd.append(user.last_name);
        tr.append(last_nameTd);
        const roleTd = document.createElement("td");
        roleTd.append(user.role);
        tr.append(roleTd);
        const date_of_birthTd = document.createElement("td");
        date_of_birthTd.append(user.date_of_birth);
        tr.append(date_of_birthTd);
        const linksTd = document.createElement("td")
        const editLink = document.createElement("button");
        editLink.append("Змінити");
        editLink.addEventListener("click", async() => await getUser(user.id));
        linksTd.append(editLink);
        const removeLink = document.createElement("button");
        removeLink.append("Видалити");
        removeLink.addEventListener("click", async () => await deleteUser(user.id));
        linksTd.append(removeLink);
        tr.appendChild(linksTd);
        return tr;
      }

      document.getElementById("resetBtn").addEventListener("click", () => reset());

      document.getElementById("saveBtn").addEventListener("click", async () => {
        const id = document.getElementById("id").value;
        const name = document.getElementById("name").value;
        const last_name = document.getElementById("last_name").value;
        const role = document.getElementById("role").value;
        const date_of_birth = document.getElementById("date_of_birth").value;
        if (id === "")
          await createUser(name, last_name, role, date_of_birth);
        else
          await editUser(id, name, last_name, role, date_of_birth);
        reset();
      });

      getUsers();
    </script>
  </body>
</html>

